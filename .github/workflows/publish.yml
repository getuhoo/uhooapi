name: Publish Python Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      skip-test:
        description: 'Skip TestPyPI (for existing releases)'
        required: false
        default: 'false'
      force:
        description: 'Force clean build (delete dist/)'
        required: false
        default: 'false'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: '**/pyproject.toml'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Run tests
      run: |
        pytest tests/ --cov=src/uhooapi --cov-report=xml -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  test-publish:
    needs: test
    # Only run on manual dispatch and when not skipping test
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.skip-test == 'false'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Clean dist directory
      run: |
        echo "Cleaning previous builds..."
        rm -rf dist/ build/ *.egg-info/
        mkdir -p dist

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine tomli

    - name: Extract package info
      id: package_info
      run: |
        PACKAGE_NAME=$(python -c "
        import tomli
        with open('pyproject.toml', 'rb') as f:
            data = tomli.load(f)
        print(data['project']['name'])
        ")

        VERSION=$(python -c "
        import tomli
        with open('pyproject.toml', 'rb') as f:
            data = tomli.load(f)
        print(data['project']['version'])
        ")

        echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Package: $PACKAGE_NAME"
        echo "Version: $VERSION"

    - name: Check if version exists on TestPyPI
      id: check_testpypi
      continue-on-error: true
      run: |
        echo "Checking if version exists on TestPyPI..."

        PACKAGE_NAME="${{ steps.package_info.outputs.package_name }}"
        VERSION="${{ steps.package_info.outputs.version }}"

        if curl -s "https://test.pypi.org/pypi/$PACKAGE_NAME/$VERSION/json" > /dev/null 2>&1; then
          echo "version_exists=true" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  Version $VERSION already exists on TestPyPI!"
          echo "Skipping TestPyPI publish..."
        else
          echo "version_exists=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Version $VERSION does not exist on TestPyPI"
        fi

    - name: Build package for TestPyPI
      # Only build if version doesn't exist on TestPyPI
      if: steps.check_testpypi.outputs.version_exists != 'true'
      run: |
        echo "Building package for TestPyPI..."
        python -m build
        echo "Built packages:"
        ls -lh dist/

    - name: Publish to TestPyPI
      # Skip if version already exists
      if: steps.check_testpypi.outputs.version_exists != 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "Publishing to TestPyPI..."

        if [ -z "$TWINE_PASSWORD" ]; then
          echo "‚ö†Ô∏è  TEST_PYPI_API_TOKEN not set"
          echo ""
          echo "To set up TestPyPI publishing:"
          echo "1. Go to https://test.pypi.org/manage/account/token/"
          echo "2. Generate an API token"
          echo "3. Add as TEST_PYPI_API_TOKEN in GitHub secrets"
          echo ""
          echo "Skipping TestPyPI publish..."
          exit 0
        fi

        echo "Uploading to TestPyPI..."
        twine upload dist/* --repository-url https://test.pypi.org/legacy/ --verbose

        PACKAGE_NAME="${{ steps.package_info.outputs.package_name }}"
        VERSION="${{ steps.package_info.outputs.version }}"

        echo ""
        echo "‚úÖ Successfully published to TestPyPI!"
        echo "üì¶ Package: $PACKAGE_NAME"
        echo "üè∑Ô∏è  Version: $VERSION"
        echo "üîó URL: https://test.pypi.org/project/$PACKAGE_NAME/$VERSION/"
        echo ""
        echo "To test installation:"
        echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ $PACKAGE_NAME==$VERSION"

  publish:
    # For releases: depends only on test
    # For manual dispatch: depends on test-publish if not skipping test, otherwise only on test
    needs: [test, test-publish]
    runs-on: ubuntu-latest
    # Only run for releases OR manual dispatch with skip-test true
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.skip-test == 'true')

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Clean dist directory if forcing
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true'
      run: |
        echo "Cleaning dist directory..."
        rm -rf dist/ build/ *.egg-info/
        mkdir -p dist

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine tomli

    - name: Extract version from pyproject.toml
      id: get_version
      run: |
        echo "Extracting version from pyproject.toml..."

        # Use tomli to extract version (we installed it above)
        PYPROJECT_VERSION=$(python -c "
        import tomli
        with open('pyproject.toml', 'rb') as f:
            data = tomli.load(f)
        print(data['project']['version'])
                ")

        # Also get package name
        PACKAGE_NAME=$(python -c "
        import tomli
        with open('pyproject.toml', 'rb') as f:
            data = tomli.load(f)
        print(data['project']['name'])
        ")

        echo "version=$PYPROJECT_VERSION" >> $GITHUB_OUTPUT
        echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "Extracted version: $PYPROJECT_VERSION"
        echo "Package name: $PACKAGE_NAME"

    - name: Check version against tag (for releases only)
      if: github.event_name == 'release'
      run: |
        echo "Checking version against release tag..."

        VERSION="${{ steps.get_version.outputs.version }}"

        # Extract tag name (remove refs/tags/ and optional v prefix)
        TAG_VERSION="${GITHUB_REF#refs/tags/}"
        TAG_VERSION="${TAG_VERSION#v}"  # Remove leading 'v' if present

        echo "PyProject Version: $VERSION"
        echo "Tag Version: $TAG_VERSION"

        if [ "$VERSION" != "$TAG_VERSION" ]; then
          echo "‚ùå ERROR: Version mismatch!"
          echo "  pyproject.toml: $VERSION"
          echo "  Release tag:    $TAG_VERSION"
          echo ""
          echo "To fix:"
          echo "1. Update version in pyproject.toml to match the tag"
          echo "2. OR create a new tag that matches the version in pyproject.toml"
          exit 1
        else
          echo "‚úÖ Version check passed"
        fi

    - name: Check if version already exists on PyPI
      id: check_pypi
      continue-on-error: true
      run: |
        echo "Checking if this version already exists on PyPI..."

        PACKAGE_NAME="${{ steps.get_version.outputs.package_name }}"
        VERSION="${{ steps.get_version.outputs.version }}"

        # Check if version exists
        if curl -s "https://pypi.org/pypi/$PACKAGE_NAME/$VERSION/json" > /dev/null 2>&1; then
          echo "version_exists=true" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  Version $VERSION already exists on PyPI!"

          # For release events, this is an error
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "‚ùå Cannot publish a release that already exists on PyPI"
            echo "You must increment the version number in pyproject.toml"
            exit 1
          fi
        else
          echo "version_exists=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Version $VERSION does not exist on PyPI"
        fi

    - name: Build package
      # Only build if version doesn't exist OR we're forcing a rebuild
      if: steps.check_pypi.outputs.version_exists != 'true' || github.event.inputs.force == 'true'
      run: |
        echo "Building package..."
        python -m build

        echo "Built packages:"
        ls -lh dist/
        echo ""
        echo "Package info:"
        for pkg in dist/*; do
          echo "  $(basename $pkg)"
        done

    - name: Check package with twine
      if: steps.check_pypi.outputs.version_exists != 'true' || github.event.inputs.force == 'true'
      run: |
        echo "Checking package with twine..."
        twine check dist/*

    - name: Publish to PyPI
      # Only publish if version doesn't exist (unless force is true for manual dispatch)
      if: |
        (steps.check_pypi.outputs.version_exists != 'true') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "Publishing to PyPI..."

        # Check if token is set
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "‚ùå ERROR: PYPI_API_TOKEN secret is not set!"
          echo ""
          echo "Setup instructions:"
          echo "1. Go to https://pypi.org/manage/account/token/"
          echo "2. Generate an API token with 'Upload packages' scope"
          echo "3. In GitHub repo: Settings ‚Üí Secrets ‚Üí Actions ‚Üí New repository secret"
          echo "4. Name: PYPI_API_TOKEN"
          echo "5. Value: pypi-YourTokenHere"
          exit 1
        fi

        # Upload with --skip-existing to avoid errors if somehow version exists
        echo "Uploading package..."
        twine upload dist/* --skip-existing --verbose

        PACKAGE_NAME="${{ steps.get_version.outputs.package_name }}"
        VERSION="${{ steps.get_version.outputs.version }}"

        echo ""
        echo "‚úÖ Upload completed!"
        echo "üì¶ Package: $PACKAGE_NAME"
        echo "üè∑Ô∏è  Version: $VERSION"
        echo "üîó PyPI URL: https://pypi.org/project/$PACKAGE_NAME/$VERSION/"

    - name: Skip publish (version already exists)
      if: steps.check_pypi.outputs.version_exists == 'true' && github.event.inputs.force == 'false'
      run: |
        echo "‚ö†Ô∏è  Skipping publish - version ${{ steps.get_version.outputs.version }} already exists on PyPI"
        echo ""
        echo "If you need to update this version:"
        echo "1. Increment the version in pyproject.toml"
        echo "2. Create a new GitHub release with the new version tag"
        echo "3. OR run this workflow manually with 'force' option checked"
        echo ""
        echo "Current version cannot be overwritten for security reasons."
