name: Publish Python Package

on:
  release:
    types: [published]
  workflow_dispatch:  # For manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13", "3.14"]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: '**/pyproject.toml'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Run tests
      run: |
        pytest tests/ --cov=src/uhooapi --cov-report=xml -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  publish:
    needs: test
    runs-on: ubuntu-latest
    # Optional: Add environment for better secret protection
    # environment: production

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get all history for proper versioning

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Verify package structure
      run: |
        echo "Checking project structure..."
        if [ ! -f "pyproject.toml" ]; then
          echo "❌ ERROR: pyproject.toml not found!"
          exit 1
        fi

        if [ ! -d "src" ] && [ ! -d "src/uhooapi" ]; then
          echo "⚠️ WARNING: src/uhooapi directory not found"
        fi

        echo "✅ Project structure looks good"
        echo "Files in repository:"
        ls -la

    - name: Extract and compare versions
      id: version-check
      run: |
        # Extract version from pyproject.toml
        if command -v python3 &> /dev/null; then
          PYTHON_CMD=python3
        else
          PYTHON_CMD=python
        fi

        PYPROJECT_VERSION=$($PYTHON_CMD -c "
        try:
            import tomli
            with open('pyproject.toml', 'rb') as f:
                data = tomli.load(f)
            print(data['project']['version'])
        except ImportError:
            # Fallback for older Python versions
            import toml
            with open('pyproject.toml', 'r') as f:
                data = toml.load(f)
            print(data['project']['version'])
        except Exception as e:
            print(f'ERROR: {e}')
            exit(1)
        ")

        echo "PyProject Version: $PYPROJECT_VERSION"
        echo "pyproject_version=$PYPROJECT_VERSION" >> $GITHUB_OUTPUT

        # For release events, check against tag
        if [[ "${{ github.event_name }}" == "release" ]]; then
          TAG_VERSION="${GITHUB_REF#refs/tags/}"
          TAG_VERSION="${TAG_VERSION#v}"  # Remove 'v' prefix if present
          echo "GitHub Tag Version: $TAG_VERSION"
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT

          if [ "$PYPROJECT_VERSION" != "$TAG_VERSION" ]; then
            echo "❌ ERROR: Version mismatch!"
            echo "  pyproject.toml: $PYPROJECT_VERSION"
            echo "  Release tag:    $TAG_VERSION"
            exit 1
          else
            echo "✅ Version check passed"
          fi
        else
          echo "⚠️  Manual trigger - skipping version check"
        fi

    - name: Build package
      run: |
        echo "Building package..."
        python -m build

        echo "Built packages:"
        ls -lh dist/

        echo "Package contents:"
        for pkg in dist/*.whl; do
          if [ -f "$pkg" ]; then
            echo "=== $pkg ==="
            unzip -l "$pkg" | head -20
          fi
        done

    - name: Check package with twine
      run: |
        echo "Checking package validity..."
        twine check dist/*

    - name: Test local installation
      run: |
        echo "Testing local installation..."
        # Install the wheel package
        pip install dist/*.whl --force-reinstall --no-deps

        # Try to import the package
        python -c "
        try:
            import uhooapi
            print(f'✅ Successfully imported uhooapi')
            # Try to get version if available
            try:
                print(f'   Version: {uhooapi.__version__}')
            except:
                pass
        except Exception as e:
            print(f'❌ Failed to import uhooapi: {e}')
            exit(1)
        "

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "Publishing to PyPI..."

        # Check if token is set
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "❌ ERROR: PYPI_API_TOKEN secret is not set!"
          echo "Please add your PyPI API token to repository secrets:"
          echo "Settings → Secrets and variables → Actions → New repository secret"
          echo "Name: PYPI_API_TOKEN"
          echo "Value: pypi-YourAPITokenHere"
          exit 1
        fi

        # Upload to PyPI
        twine upload dist/* --verbose

        echo "✅ Package published successfully!"

        # Show published package info
        PACKAGE_NAME=$(python -c "
        import tomli
        with open('pyproject.toml', 'rb') as f:
            data = tomli.load(f)
        print(data['project']['name'])
        ")
        echo "Package: $PACKAGE_NAME"
        echo "Version: ${{ steps.version-check.outputs.pyproject_version }}"

    - name: Verify publication
      run: |
        echo "Verifying publication (waiting 30 seconds for PyPI to update)..."
        sleep 30

        PACKAGE_NAME=$(python -c "
        import tomli
        with open('pyproject.toml', 'rb') as f:
            data = tomli.load(f)
        print(data['project']['name'])
        ")
        PACKAGE_VERSION="${{ steps.version-check.outputs.pyproject_version }}"

        echo "Checking if $PACKAGE_NAME==$PACKAGE_VERSION is available on PyPI..."

        # Try to fetch package info
        curl -s "https://pypi.org/pypi/$PACKAGE_NAME/$PACKAGE_VERSION/json" | \
          python -c "
          import sys, json
          try:
              data = json.load(sys.stdin)
              print(f'✅ Package {data[\"info\"][\"name\"]} version {data[\"info\"][\"version\"]} found on PyPI!')
              print(f'   Summary: {data[\"info\"].get(\"summary\", \"No summary\")}')
          except Exception as e:
              print(f'⚠️  Could not verify package on PyPI (might need more time): {e}')
          "

  # Optional: Test publish to TestPyPI first
  test-publish:
    needs: test
    if: github.event_name == 'workflow_dispatch'  # Only on manual trigger
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Publish to TestPyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "Publishing to TestPyPI..."

        if [ -z "$TWINE_PASSWORD" ]; then
          echo "⚠️  PYPI_API_TOKEN not set, skipping TestPyPI publish"
          echo "To enable, add PYPI_API_TOKEN to repository secrets"
          exit 0
        fi

        twine upload dist/* --repository-url https://test.pypi.org/legacy/ --verbose
        echo "✅ Package published to TestPyPI"
