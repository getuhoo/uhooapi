name: Publish Python Package

on:
  release:
    types: [published]
  workflow_dispatch:  # For manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13", "3.14"]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: '**/pyproject.toml'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Run tests
      run: |
        pytest tests/ --cov=src/uhooapi --cov-report=xml -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  publish:
    needs: test-publish
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install build tools and TOML parser
      run: |
        python -m pip install --upgrade pip
        pip install build twine tomli

    - name: Verify package structure
      run: |
        echo "Checking project structure..."
        if [ ! -f "pyproject.toml" ]; then
          echo "‚ùå ERROR: pyproject.toml not found!"
          exit 1
        fi
        echo "‚úÖ pyproject.toml found"

        # List project structure
        echo "Project structure:"
        find . -type f -name "*.py" | head -20
        echo "..."
        ls -la

    - name: Extract version from pyproject.toml
      id: get_version
      run: |
        echo "Extracting version from pyproject.toml..."

        # Method 1: Use tomli (Python module we just installed)
        PYPROJECT_VERSION=$(python -c "
        try:
            import tomli
            with open('pyproject.toml', 'rb') as f:
                data = tomli.load(f)
            version = data['project']['version']
            print(version)
        except Exception as e:
            print(f'Error with tomli: {e}')
            # Method 2: Use simple grep as fallback
            import re
            with open('pyproject.toml', 'r') as f:
                content = f.read()
            match = re.search(r'version\s*=\s*[\"\\']([^\"\\']+)[\"\\']', content)
            if match:
                print(match.group(1))
            else:
                # Method 3: Look for version line
                with open('pyproject.toml', 'r') as f:
                    for line in f:
                        if 'version' in line and '=' in line:
                            version = line.split('=')[1].strip().strip('\"').strip(\"'")
                            print(version)
                            break
        ")

        echo "Extracted version: $PYPROJECT_VERSION"
        echo "version=$PYPROJECT_VERSION" >> $GITHUB_OUTPUT

    - name: Check version against tag (for releases)
      if: github.event_name == 'release'
      run: |
        echo "Checking version against release tag..."

        # Get the extracted version
        PYPROJECT_VERSION="${{ steps.get_version.outputs.version }}"

        # Extract tag name (remove refs/tags/ and optional v prefix)
        TAG_VERSION="${GITHUB_REF#refs/tags/}"
        TAG_VERSION="${TAG_VERSION#v}"  # Remove leading 'v' if present

        echo "PyProject Version: $PYPROJECT_VERSION"
        echo "Tag Version: $TAG_VERSION"

        if [ "$PYPROJECT_VERSION" != "$TAG_VERSION" ]; then
          echo "‚ùå ERROR: Version mismatch!"
          echo "  pyproject.toml: $PYPROJECT_VERSION"
          echo "  Release tag:    $TAG_VERSION"
          echo ""
          echo "Make sure the version in pyproject.toml matches your GitHub release tag."
          echo "Example: If your tag is v1.0.0, pyproject.toml should have version = \"1.0.0\""
          exit 1
        else
          echo "‚úÖ Version check passed"
        fi

    - name: Build package
      run: |
        echo "Building package..."
        python -m build

        echo "Built packages in dist/:"
        ls -lh dist/

        # Check what was built
        echo "Package files:"
        for file in dist/*; do
          echo "  - $(basename $file) ($(du -h $file | cut -f1))"
        done

    - name: Check package with twine
      run: |
        echo "Checking package validity with twine..."
        twine check dist/*

    - name: Test local installation
      run: |
        echo "Testing local installation..."

        # Find the wheel file
        WHEEL_FILE=$(ls dist/*.whl 2>/dev/null | head -1)

        if [ -z "$WHEEL_FILE" ]; then
          echo "‚ö†Ô∏è  No wheel file found, testing with source distribution"
          # Try source distribution
          pip install dist/*.tar.gz --force-reinstall --no-deps
        else
          echo "Installing wheel: $WHEEL_FILE"
          pip install "$WHEEL_FILE" --force-reinstall --no-deps
        fi

        # Try to import the package
        echo "Testing import..."
        python -c "
        try:
            import uhooapi
            print('‚úÖ Successfully imported uhooapi')
            # Try to get version from package
            try:
                print(f'   Package version: {uhooapi.__version__}')
            except AttributeError:
                # Try to get version from metadata
                import importlib.metadata
                try:
                    version = importlib.metadata.version('uhooapi')
                    print(f'   Package version (from metadata): {version}')
                except:
                    print('   Could not determine version')
        except ImportError as e:
            print(f'‚ùå Failed to import uhooapi: {e}')
            print('Trying to find installed packages...')
            import subprocess
            result = subprocess.run(['pip', 'list'], capture_output=True, text=True)
            print(result.stdout)
            exit(1)
        except Exception as e:
            print(f'‚ùå Unexpected error: {e}')
            exit(1)
        "

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "Publishing to PyPI..."

        # Check if token is set
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "‚ùå ERROR: PYPI_API_TOKEN secret is not set!"
          echo ""
          echo "To fix this:"
          echo "1. Go to https://pypi.org/manage/account/token/"
          echo "2. Generate an API token (with 'Upload packages' scope)"
          echo "3. In your GitHub repo: Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "4. Click 'New repository secret'"
          echo "5. Name: PYPI_API_TOKEN"
          echo "6. Value: pypi-YourTokenHere"
          echo ""
          exit 1
        fi

        # Upload to PyPI
        echo "Uploading package to PyPI..."
        twine upload dist/* --verbose

        echo ""
        echo "‚úÖ Package published successfully!"

        # Show published info
        PACKAGE_NAME=$(python -c "
        try:
            import tomli
            with open('pyproject.toml', 'rb') as f:
                data = tomli.load(f)
            print(data['project']['name'])
        except:
            # Fallback: extract from first line of pyproject.toml
            import re
            with open('pyproject.toml', 'r') as f:
                content = f.read()
            match = re.search(r'name\s*=\s*[\"\\']([^\"\\']+)[\"\\']', content)
            if match:
                print(match.group(1))
            else:
                print('unknown-package')
        ")

        VERSION="${{ steps.get_version.outputs.version }}"
        echo "üì¶ Package: $PACKAGE_NAME"
        echo "üè∑Ô∏è  Version: $VERSION"
        echo "üîó PyPI URL: https://pypi.org/project/$PACKAGE_NAME/$VERSION/"

    - name: Verify publication (optional)
      run: |
        echo "Waiting for PyPI to update..."
        sleep 10

        PACKAGE_NAME=$(python -c "
        try:
            import tomli
            with open('pyproject.toml', 'rb') as f:
                data = tomli.load(f)
            print(data['project']['name'])
        except:
            exit(0)  # Skip if we can't get name
        ")

        VERSION="${{ steps.get_version.outputs.version }}"

        echo "Checking if $PACKAGE_NAME $VERSION is available on PyPI..."

        # Try to check with curl (but don't fail if it doesn't work yet)
        curl -s "https://pypi.org/pypi/$PACKAGE_NAME/$VERSION/json" > /tmp/pypi_check.json 2>/dev/null || true

        if [ -s /tmp/pypi_check.json ]; then
          echo "‚úÖ Package is available on PyPI!"
        else
          echo "‚ö†Ô∏è  Package may not be visible yet (can take a few minutes)"
        fi

  # Optional: Test publish to TestPyPI
  test-publish:
    needs: test
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.14"

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine tomli

    - name: Build package
      run: |
        python -m build

    - name: Publish to TestPyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "Publishing to TestPyPI..."

        if [ -z "$TWINE_PASSWORD" ]; then
          echo "‚ö†Ô∏è  TEST_PYPI_API_TOKEN not set, skipping TestPyPI publish"
          echo ""
          echo "To enable TestPyPI publishing:"
          echo "1. Go to https://test.pypi.org/manage/account/token/"
          echo "2. Generate an API token"
          echo "3. Add it as TEST_PYPI_API_TOKEN in GitHub secrets"
          exit 0
        fi

        echo "Uploading to TestPyPI..."
        twine upload dist/* --repository-url https://test.pypi.org/legacy/ --verbose

        # Extract package name
        PACKAGE_NAME=$(python -c "
        import tomli
        with open('pyproject.toml', 'rb') as f:
            data = tomli.load(f)
        print(data['project']['name'])
        ")

        VERSION=$(python -c "
        import tomli
        with open('pyproject.toml', 'rb') as f:
            data = tomli.load(f)
        print(data['project']['version'])
        ")

        echo ""
        echo "‚úÖ Package published to TestPyPI!"
        echo "üì¶ Package: $PACKAGE_NAME"
        echo "üè∑Ô∏è  Version: $VERSION"
        echo "üîó TestPyPI URL: https://test.pypi.org/project/$PACKAGE_NAME/$VERSION/"
        echo ""
        echo "To test installation:"
        echo "pip install --index-url https://test.pypi.org/simple/ $PACKAGE_NAME==$VERSION"
